<p-confirmDialog header="Neuer Eintrag" acceptLabel="Ja" rejectLabel="Nein"></p-confirmDialog>

<p-dialog header="Entity Auswahl" [draggable]="false" [modal]="true" [(visible)]="displayEntitySelectionDialog" [style]="{width: '80%'}" appendTo="body">
  <app-dynamic-table *ngIf="entitySelectionTableData" [tableData]="entitySelectionTableData" (entitySelection)="entitySelected($event)"></app-dynamic-table>
</p-dialog>

<div *ngIf="configuration" class="ui-g-12" style="padding:0px">
  <div [ngClass]="{'card': tableData.showHeadline, 'card-w-title': tableData.showHeadline }">
    <h1 *ngIf="tableData.showHeadline">{{tableData.tableName}}</h1>
    <p-table #dt [columns]="fields" selectionMode="single" [value]="entityData.data" dataKey="id" [(selection)]="selectedEntry" (onRowSelect)="rowSelect()" (onRowUnselect)="rowUnselect()"
      [paginator]="tableData.pagination" [(rows)]="configuration.rowsPerPage" [rowsPerPageOptions]="[10,25,50]" [responsive]="true" [lazy]="true" (onLazyLoad)="loadLazy($event)" [loading]="loading"
      [totalRecords]="entityData.count" [scrollable]="tableData.scrollable || configuration?.scrollable" [scrollHeight]="tableData.scrollHeight" styleClass="ui-table-customers" (window:resize)="onTableResize($event)">
      <ng-template *ngIf="tableData.showHeader" pTemplate="caption">
        {{configuration.displayName}}
        <button pButton (click)="showAddEntityDialog()" icon="pi pi-plus" style="float: right; margin-top: -5px;"></button>
        <button pButton (click)="refreshTableContents()" icon="pi pi-undo" style="float: right; margin-top: -5px; margin-right: 5px;"></button>
      </ng-template>
      <!-- Table Headers -->
      <ng-template pTemplate="header" let-columns>
        <tr>
          <th *ngFor="let col of columns" [style.width]="calcWidth(col, dt.el.nativeElement.offsetWidth)" [ngSwitch]="col.filterType" style="padding: 0px;">
            <div style="display:flex; flex-direction: column;">            
              <!-- Header titles and sorting icon-->
              <div [pSortableColumn]="col.sortable ? col.field : null" style="margin: 0px">
                <p style="margin: 0px; padding: 5px" style="word-wrap: break-word;">
                  {{col.header}}
                  <p-sortIcon *ngIf="col.sortable" [field]="col.field"></p-sortIcon>
                </p>
                <div *ngIf="filtersInTable" style="height: 36px; width: 100%;"></div>
              </div>

              <!-- Filters -->
              <div *ngIf="col.filterType !== 'none'" style="margin: auto; margin-top: -32px; height: 32px; width: 80%;">
                <input *ngSwitchCase="'text'" pInputText type="text" style="width:100%; max-width: 200px;" (input)="dt.filter($event.target.value, col.field, 'contains')">
                <input *ngSwitchCase="'integer'" type="number" pInputText pKeyFilter="int" style="width:100%; max-width: 200px;" (input)="dt.filter($event.target.value, col.field, 'equals')">
                <p-dropdown *ngSwitchCase="'dropdown'" [options]="col.options" optionLabel="_repr_" [style]="{'width':'100%'}" (onChange)="dt.filter($event.value, col.field, 'equals')"></p-dropdown>
                <p-multiSelect *ngSwitchCase="'multiSelect'" [options]="col.options" [filter]='col.type === "CatalogueEntry"' [style]="{'width':'100%'}" (onChange)="dt.filter($event.value, col.field, 'in')" [defaultLabel]="'Auswählen..'" [selectedItemsLabel]="'{0} Element(e)'">
                  <ng-template let-item let-i="index" pTemplate="item">
                    <span *ngIf="item._repr_ !== '__icon__';else displayIcon2">{{item._repr_}}</span>
                    <ng-template #displayIcon2>
                      <i [class]="item.id.icon" [ngStyle]="{'color': item.id.color}" style="font-size: 2em; vertical-align: middle;"></i>
                    </ng-template>
                  </ng-template>
                </p-multiSelect>
              </div>

            </div>
          </th>
          
          <th *ngIf="showButtons" style="width:135px">Bearbeiten</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-rowData let-fields="columns">
        <!-- Processing and displaying the data -->
        <tr [pSelectableRow]="rowData" (dblclick)="doubleClickTableRow(rowData)">
          <td *ngFor="let field of fields" [style.width]="calcWidth(field, dt.el.nativeElement.offsetWidth)" style="word-wrap: break-word;">
            <div style="display: flex; align-items: center;" [style.justify-content]="field.type === 'boolean' ? 'center' : 'unset'">
              <ng-container [var]="{isEdited: false, isFocused: false}" #cell="var">
                <ng-container *ngIf="cell.isEdited else displayEditable" [ngSwitch]="field.type">
                  <ng-container *ngSwitchCase="'String'">
                    <input [name]="field.field" type="text" [(ngModel)]="rowData[field.field]" style="width: calc(100% - 30px)" pInputText
                      (click)="$event.stopPropagation()" (blur)="setBlur(cell)" (focus)="cell.isFocused = true;">
                    <button *ngIf="cell.isFocused" pButton type="button" icon="pi pi-check" (click)="cell.isEdited = false; editComplete(rowData);"></button>
                    <button *ngIf="!cell.isFocused" pButton type="button" icon="pi pi-times" (click)="cell.isEdited = false; restoreContent(field.field, rowData)"></button>
                  </ng-container>
                  <ng-container *ngSwitchCase="'int'">
                    <input [name]="field.field" type="number" [(ngModel)]="rowData[field.field]" style="width: calc(100% - 30px)" pInputText
                      (click)="$event.stopPropagation()" (blur)="setBlur(cell)" (focus)="cell.isFocused = true;">
                    <button *ngIf="cell.isFocused" pButton type="button" icon="pi pi-check" (click)="cell.isEdited = false; editComplete(rowData);"></button>
                    <button *ngIf="!cell.isFocused" pButton type="button" icon="pi pi-times" (click)="cell.isEdited = false; restoreContent(field.field, rowData)"></button>
                  </ng-container>
                  <ng-container *ngSwitchCase="'boolean'">
                    <p-checkbox [name]="field.field" [binary]="true" [(ngModel)]="rowData[field.field]" ngClass="centerCheckbox"
                      (onChange)="cell.isEdited = false; editComplete(rowData);"
                      (click)="$event.stopPropagation()"></p-checkbox>
                  </ng-container>
                  <ng-container *ngSwitchCase="'Date'">
                    <p-calendar [name]="field.field" showTime="true" hourFormat="24" dateFormat="dd.mm.yy" [style]="{'width':'100%'}" [inputStyle]="{'width':'100%'}" [(ngModel)]="rowData[field.field]"
                      (click)="$event.stopPropagation()" (onClose)="cell.isEdited = false; restoreContent(field.field, rowData)"></p-calendar>
                    <button pButton type="button" icon="pi pi-check" (click)="cell.isEdited = false; editComplete(rowData);"></button>
                  </ng-container>
                  <ng-container *ngSwitchCase="'CatalogueEntry'">
                    <p-dropdown [placeholder]="field.header" [name]="field.field" [options]="field.options" [style]="{'min-width':'5em', 'width': '100%'}" optionLabel="_repr_" [(ngModel)]="rowData[field.field]"
                      (onChange)="cell.isEdited = false; editComplete(rowData)"></p-dropdown>
                  </ng-container>
                  <ng-container *ngSwitchCase="'Currency'">
                    <div class="ui-inputgroup">            
                      <input [name]="field.field" [(ngModel)]="rowData[field.field]" pattern="^\d{1,3}((\.)?\d{3})*(,\d{1,2})?$" id="float-input" type="text" style="width: calc(100% - 30px); font-family: monospace;"
                        (click)="$event.stopPropagation()" (blur)="setBlur(cell)" (focus)="cell.isFocused = true;">
                      <span class="ui-inputgroup-addon">{{currency$ | async}}</span>
                    </div>
                    <button *ngIf="cell.isFocused" pButton type="button" icon="pi pi-check" (click)="cell.isEdited = false; editComplete(rowData);"></button>
                    <button *ngIf="!cell.isFocused" pButton type="button" icon="pi pi-times" (click)="cell.isEdited = false; restoreContent(field.field, rowData)"></button>
                  </ng-container>
                  <ng-container *ngSwitchDefault>
                    <input [disabled]="true" [placeholder]="rowData[field.field]?._repr_" style="width: calc(100% - 2.143em)" pInputText
                      (click)="$event.stopPropagation()">
                    <button pButton type="button" (click)="cell.isEdited = false; $event.stopPropagation(); openEntitySelectionDialog(field, rowData['id'])" icon="pi pi-pencil"></button>
                  </ng-container>
                </ng-container>
                <ng-template #displayEditable>
                  <span class="ui-column-title">{{field.header}}</span>
                  <ng-container [ngSwitch]="field.type">
                    <div *ngSwitchCase="'Currency'" style="font-family: monospace; text-align: right;">{{processData(rowData[field.field], field)}}&nbsp;{{currency$ | async}}</div>
                    <div *ngSwitchCase="'Icon'"><i [class]="rowData[field.field]?.icon" [ngStyle]="{'color': rowData[field.field]?.color}" style="font-size: 2em;"></i></div>
                    <div *ngSwitchCase="'json'" style="font-family: monospace;">{{processData(rowData[field.field], field)}}</div>
                    <div *ngSwitchCase="'python'" style="font-family: monospace;">{{processData(rowData[field.field], field)}}</div>
                    <div *ngSwitchDefault>{{processData(rowData[field.field], field)}}</div>
                  </ng-container>
                  <i *ngIf="field.editable" class="pi pi-pencil cellEditIcon" (click)="cell.isEdited = true; $event.stopPropagation(); storeContent(field.field, rowData)"></i>
                </ng-template>
              </ng-container>
            </div>
          </td>


          <!-- Crud Buttons -->
          <td *ngIf="showButtons" style="text-align: center; width: 135px;">
            <code *ngIf="configuration?.type !== 'FileAttachment'" class="html">
              <ng-template [appPermissionCheck]="root.dto.$dtoType.write" [appPermissionCheckVarDict]="{'$dtoType':configuration.type}">
                <button pButton type="button" icon="pi pi-pencil" class="crudButton" pTooltip="Bearbeiten" (click)="updateEntity(rowData)"></button>
              </ng-template>
            </code>

            <code *ngIf="configuration?.type !== 'FileAttachment'" class="html">
              <ng-template [appPermissionCheck]="root.dto.$dtoType.delete" [appPermissionCheckVarDict]="{'$dtoType':configuration.type}">
                <button pButton type="button" icon="pi pi-trash" class="crudButton" pTooltip="Löschen" (click)="deleteEntity(rowData)"></button>
              </ng-template>
            </code>

            <code *ngIf="configuration?.type !== 'FileAttachment'" class="html">                                                                                                                                           
                <button *ngFor="let action of rowData._actions_" pButton type="button" [icon]="configuration.actions[action].icon" class="crudButton" (click)="execute(configuration.actions[action].hrid, configuration.type, rowData['id'])"></button>
            </code>

            <code *ngIf="configuration?.type === 'FileAttachment'" class="html">
              <ng-template [appPermissionCheck]="root.dto.FileAttachment.download">
                <button  pButton type="button" icon="fa fa-download" class="crudButton" fileSaver
                pTooltip="Herunterladen" [method]="'GET'" [fileName]="rowData['fileName']" [url]="downloadUrl(rowData['id'])"></button>
              </ng-template>
            </code>

          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <app-dynamic-table-attachments *ngIf="tableData.showAttachments" [configName]="configuration.type" [entryId]="selectedEntryId"></app-dynamic-table-attachments>

</div>
