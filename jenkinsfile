master_version = '1.0.0'
version = '0.9-SNAPSHOT'
tomcat_service = ''
tomcat_port = ''
tomcat_path = ''
app_name = 'jmeleon-ui'

pipeline {
    agent any
	
	options {
		buildDiscarder(logRotator(numToKeepStr: '15', artifactNumToKeepStr: '15'))
	}
	
	triggers {
	  pollSCM 'H/2 * * * *'
	}
	
	environment {
		JAVA_HOME = ''
	}
	
	tools {
        //maven 'Maven 3.6.0'
        jdk 'jdk8'
    }
	
    stages {
        stage ('Initialize') {
            steps {
				sh '''
					echo "PATH = ${PATH}"
					echo "M2_HOME = ${M2_HOME}"
					echo "M2 version:" + `mvn --version`
				'''
				script {
					if (env.BRANCH_NAME == 'master') {
						version = master_version
					} 
					echo "set build version to ${version}"
				}
            }
        }
		
		stage('Build') {
            steps {
				sh "bash ./jenkins/build.sh ${env.BUILD_NUMBER} ${version}"
	        }
        }

        stage('Deploy') {
            steps {
				script{
					if (env.BRANCH_NAME == 'master') {
						tomcat_service = 'jmeleon_qa'
						tomcat_path = '/opt/tomcat/tomcat_jmeleon_qa'
						tomcat_port = '8123'
					} 
					if (env.BRANCH_NAME == 'develop') {
						tomcat_service = 'tomcat'
						tomcat_path = '/opt/tomcat/apache-tomcat-8.5.41'
						tomcat_port = '8023'
					} 
				}
				sh "bash ./jenkins/deploy.sh ${tomcat_service} ${tomcat_port} ${tomcat_path} ${app_name}"
        }
		
/*        stage('Upload') {
		    when {
                branch 'master'
            }
            steps {
			
                echo 'uploading artefacts'
				sh "bash ./jenkins/upload_master.sh ${version}"
				slackSend color: "good", message: "Artefact: ${env.JOB_NAME} with version ${version} was uploaded to owncloud"
            }
        }
    
	}
*/
    post {
		always {
			slack_notifier(currentBuild.currentResult)
		}
	}
}

def slack_notifier(String buildResult) {
  if ( buildResult == "SUCCESS" ) {
	
    slackSend teamDomain: "simply4it", channel: "#jenkins_notifications", tokenCredentialId: "simply4it_jenkins", color: "good", message: "Job: ${env.JOB_NAME} with buildnumber ${env.BUILD_NUMBER} was successful"
  }
  else if( buildResult == "FAILURE" ) { 
    slackSend teamDomain: "simply4it", channel: "#jenkins_notifications", tokenCredentialId: "simply4it_jenkins", color: "danger", message: "Job: ${env.JOB_NAME} with buildnumber ${env.BUILD_NUMBER} failed"
  }
  else if( buildResult == "UNSTABLE" ) { 
    slackSend teamDomain: "simply4it", channel: "#jenkins_notifications", tokenCredentialId: "simply4it_jenkins", color: "warning", message: "Job: ${env.JOB_NAME} with buildnumber ${env.BUILD_NUMBER} was unstable"
  }
  else {
    slackSend teamDomain: "simply4it", channel: "#jenkins_notifications", tokenCredentialId: "simply4it_jenkins", color: "danger", message: "Job: ${env.JOB_NAME} with buildnumber ${env.BUILD_NUMBER} was unclear"	
  }
}
